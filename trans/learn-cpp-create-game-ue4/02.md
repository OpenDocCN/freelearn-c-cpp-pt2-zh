# 第二章变量和内存

要编写你的 C++游戏程序，你需要你的电脑记住很多东西。 例如玩家在世界的什么地方，他有多少生命点，他还剩下多少弹药，物品在世界的什么地方，它们提供了什么电源，以及组成玩家屏幕名称的字母。

你所拥有的计算机内部实际上有一种电子画板，叫做*存储器，*或 RAM。 从物理上讲，计算机内存是由硅制成的，其外观类似于以下屏幕截图所示：

![Variables and Memory](../images/00022.jpeg)

这个 RAM 看起来像停车场吗？ 因为这就是我们要用到的比喻

RAM 是随机存取存储器(Random Access Memory)的缩写。 它被称为随机访问，因为您可以随时访问它的任何部分。 如果你还留着一些 CD，它们就是非随机存取的一个例子。 CD 应该按顺序读取和播放。 我还记得很久以前迈克尔·杰克逊(Michael Jackson)的*Dangge*专辑中的跳轨，在 CD 上切换曲目花了很多时间！ 然而，跳来跳去并访问 RAM 的不同单元并不需要花费太多时间。 RAM 是一种称为闪存的快速存储器访问。

RAM 被称为易失性闪存存储器，因为当计算机关机时，RAM 的内容会被清除，RAM 的旧内容也会丢失，除非它们先保存到硬盘上。

对于永久存储，您必须将数据保存到硬盘中。 硬盘主要有两种类型，基于盘片的**硬盘驱动器**(**硬盘**)和**固态驱动器**(**固态硬盘**)。 固态硬盘比基于盘片的硬盘更现代，因为它们使用 RAM 的快速存取(闪存)存储原理。 然而，与 RAM 不同的是，SSD 上的数据在计算机关机后仍然存在。 如果你能买到固态硬盘，我强烈建议你使用它！ 基于盘片的驱动器已过时。 我们需要一种在 RAM 上预留空间并对其进行读写的方法。 幸运的是，C++让这一切变得很容易。

# 变量

我们可以读取或写入的计算机内存中的保存位置称为*变量*。

变量是其值可以变化的组件。 在计算机程序中，您可以将变量看作一个容器，您可以在其中存储一些数据。 在 C++中，这些数据容器(变量)具有类型。 您必须使用正确类型的数据容器将数据保存在程序中。

如果要保存整数，如 1、0 或 20，您将使用`int`类型的容器。 您可以使用浮点型容器来携带浮点(十进制)值，例如 38.87，也可以使用字符串变量来携带字母串(可以将其视为“珍珠串”，其中每个字母都是一颗珍珠)。

您可以将 RAM 中的预留位置想象成在停车场中预留停车位：一旦我们声明了变量并为其找到了位置，操作系统就不会给其他任何人(甚至是运行在同一台机器上的其他程序)分配这块 RAM。 变量旁边的 RAM 可能未使用，也可能被其他程序使用。

### 提示

操作系统的存在是为了防止程序互相践踏对方的脚趾，同时访问相同的计算机硬件位。 一般来说，民用计算机程序不应该读写彼此的内存。 但是，某些类型的作弊程序(例如 maphack)会秘密访问您的程序的内存。 PunkBuster 等程序的引入是为了防止网络游戏中的作弊行为。

## 声明变量-触摸硅片

使用 C++在计算机内存中保留一个点很容易。 我们想用一个好的、描述性的名称来命名我们将存储数据的内存块。

例如，我们知道 Player**Hit Points**(**hp**)将是一个整数(整数)，如 1、2、3 或 100。 要获得一片硅片以将玩家的 HP 存储在内存中，我们将声明以下代码行：

```
int hp;     // declare variable to store the player's hp
```

这行代码保留了一小块 RAM 来存储一个整数(`int`是整数的缩写)，称为 hp。 下面是我们用来存储玩家的 HP 的 RAM 块的一个例子。 这在内存中为我们预留了一个停车位(在所有其他停车位中)，我们可以通过它的标签(Hp)来引用内存中的这个停车位。

![Declaring variables – touching the silicon](../images/00023.jpeg)

在内存中的所有其他空间中，我们得到一个位置来存储我们的 hp 数据。

请注意，变量空间在此图中的类型标记为**int**：如果它是双精度变量或不同类型变量的空格。 C++不仅按名称而且按变量类型记住您在内存中为程序保留的空格。

注意，我们还没有把任何东西放进惠普的盒子里！ 我们稍后会这样做-现在，hp 变量的值还没有设置，所以它将具有前一个占用者留在那个停车位上的值(可能是另一个程序留下的值)。 告诉 C++变量的类型很重要！ 稍后，我们将声明一个变量来存储十进制值，例如 3.75。

### 读取和写入您在内存中保留的位置

将值写入内存很容易！ 有了`hp`变量后，只需使用`=`符号将其写入：

```
hp = 500;
```

瞧啊！ 这位选手有 500 马力。

读取变量同样简单。 要打印出变量的值，只需这样做：

```
cout << hp << endl;
```

这将打印存储在 hp 变量中的值。 如果更改 hp 的值，然后再次使用`cout`，将打印最新的值，如下所示：

```
hp = 1200;
cout << hp << endl; // now shows 1200
```

## 数字就是一切

当你开始计算机编程时，你需要习惯的一件事是，在计算机内存中可以仅仅以数字的形式存储数量惊人的东西。 球员的惠普？ 正如我们在上一节中所看到的，hp 可以只是一个整数。 如果玩家受伤，我们会减少这个数字。 如果玩家恢复了健康，我们就会增加数量。

颜色也可以存储为数字！ 如果你使用过标准的图像编辑程序，通常会有一些滑块来指示颜色，比如使用了多少红色、绿色和蓝色，比如 Pixelmator 的颜色滑块。 然后，一种颜色由三个数字表示。 下面截图中显示的紫色是(R=127，G=34，B=203)：

![Numbers are everything](../images/00024.jpeg)

世界几何学怎么样？ 这些也只是数字：我们所要做的就是存储 3D 空间点(x、y 和 z 坐标)的列表，然后存储另一个解释如何将这些点连接成三角形的点列表。 在下面的屏幕截图中，我们可以看到如何使用 3D 空间点来表示世界几何体：

![Numbers are everything](../images/00025.jpeg)

颜色的数字和 3D 空间点的数字的组合将允许您在游戏世界中绘制大型彩色风景。

前面个例子的诀窍在于我们如何解释存储的数字，这样我们就可以让它们表示我们想要它们表示的意思。

## 有关变量的更多信息

你可以把变量想象成动物搬运箱。 运猫器可以用来载猫，但不能载狗。 同样，您应该使用浮点型变量来携带十进制值的数字。 如果在`int`变量中存储十进制值，它将不适合：

```
int x = 38.87f;
cout << x << endl; // prints 38, not 38.87
```

这里实际发生的情况是，C++在 38.87 上执行自动类型转换，*将它转换为一个整数，以便放入`int`小盒中。 它丢弃小数将 38.87 转换为整数值 38。*

因此，例如，我们可以修改代码以包括使用三种类型的变量，如以下代码所示：

```
#include <iostream>
#include <string>  // need this to use string variables!
using namespace std;
int main()
{
  string name;
  int goldPieces;
  float hp;
  name = "William"; // That's my name
  goldPieces = 322; // start with this much gold 
  hp = 75.5f;       // hit points are decimal valued
  cout << "Character " << name << " has " 
           << hp << " hp and " 
           << goldPieces << " gold.";
}
```

在前三行中，我们声明了三个存储数据部分的框，如下所示：

```
string name;
int goldPieces;
float hp;
```

这三条线在内存中保留了三个位置(如停车位)。 接下来的三行用我们需要的值填充变量，如下所示：

```
name = "William";
goldPieces = 322;
hp = 75.5f;
```

在计算机内存中，这将如下图所示：

![More on variables](../images/00026.jpeg)

您可以随时更改变量的内容。 您可以使用`=`赋值运算符编写变量，如下所示：

```
goldPieces = 522;// = is called the "assignment operator"
```

您还可以随时读取变量的内容。 下面三行代码就是这样做的，如下所示：

```
cout << "Character " << name << " has " 
     << hp << " hp and " 
     << goldPieces << " gold.";
```

看看这一行：

```
cout << "I have " << hp << " hp." << endl;
```

在这行中，单词`hp`有两种用法。 一个在双引号之间，另一个不在双引号之间。 双引号之间的单词始终与您键入的完全相同。 如果不使用双引号(例如，`<< hp <`)，则执行变量查找。 如果变量不存在，则会出现编译器错误(未声明的标识符)。

内存中有一个分配给名字的空间，一个用于玩家拥有多少`goldPieces`的空间，以及一个用于玩家的 HP 的空间。

### 提示

通常，您应该始终尝试在正确类型的变量中存储正确类型的数据。 如果您碰巧存储了错误类型的数据，您的代码可能会出现错误行为。

## C++中的数学

C++中的数学很容易做；+(加)、-(减)、*(乘)、/(除)是所有常见的 C++运算，并且将遵循正确的 BEDMA 顺序(方括号、指数、除法、乘法、加法和减法)。 例如，我们可以执行以下代码所示的操作：

```
int answer = 277 + 5 * 4 / 2 + 20;
```

您可能还不熟悉的另一个运算符是%(模数)。 模数(例如，10%3)求出`x`除以`y`时的余数。 有关示例，请参阅下表：

<colgroup class="calibre18"><col class="calibre19"> <col class="calibre19"> <col class="calibre19"></colgroup> 
| 

操作员(名称)

 | 

例证 / 范例 / 榜样 / 例子

 | 

回答 / 符合 / 顶嘴 / 作出反应

 |
| --- | --- | --- |
| +(更多) | 7+3 | 10 个 |
| -(减) | 8-5 | 3. |
| *(次数) | 5*6 | 30 个 |
| (英文)(2) | 12/6 | 2 个 |
| %(模块) | 10%3% | 1(因为 10/3 是 3，所以余数=1)。 |

然而，我们通常不想用这种方式做数学。 相反，我们通常希望将变量的值更改一定的计算量。 这是一个更难理解的概念。 假设玩家遇到一个小鬼，造成 15 点伤害。

下面这行代码将用于减少玩家的生命值 15(信不信由你)：

```
hp = hp - 15;                  // probably confusing :)
```

你可能会问为什么。 因为在右边，我们正在计算 hp(`hp-15`)的新值。 在找到 hp 的新值(比以前少 15)之后，新值被写入 hp 变量。

### 提示

**瀑布**

未初始化的变量具有以前保存在内存中的位模式。 声明变量不会清除内存。 因此，假设我们使用了以下代码行：

```
int hp;
hp = hp - 15;
```

第二行代码将 HP 从其先前的值减少 15。 如果我们从未将 hp 设置为 100 左右，它之前的值是多少？ 它可以是 0，但不总是。

最常见的错误之一是在没有首先初始化变量的情况下继续使用它。

以下是执行此操作的简写语法：

```
hp -= 15;
```

除了`-=`之外，您还可以使用+=向变量添加一些金额，使用*=将变量乘以金额，使用/=将变量除以一些金额。

### 练习

执行以下操作后记下`x`的值；然后与您的编译器核对：

<colgroup class="calibre18"><col class="calibre19"> <col class="calibre19"></colgroup> 
| 

锻炼 / 运动 /

 | 

解决方案

 |
| --- | --- |
| `int x = 4; x += 4;` | 8 个 |
| `int x = 9; x-=2;` | 7. |
| `int x = 900; x/=2;` | 四百五十 |
| `int x = 50; x*=2;` | 100 个 |
| `int x = 1; x += 1;` | 2 个 |
| `int x = 2; x -= 200;` | -198 |
| `int x = 5; x*=5;` | 25 个 |

## 通用变量语法

在上一节中，您了解到在 C++中保存的每个数据都有一个类型。 所有变量都是以相同的方式创建的；在 C++中，变量声明的形式如下：

```
variableType variableName;
```

`variableType`告诉您我们将在变量中存储什么类型的数据。 `variableName`是我们将用来读取或写入那段内存的符号。

## 基元类型

我们之前讨论了计算机内的所有数据在某一时刻将会是一个数字。 您的计算机代码负责正确解释该数字。

据说 C++只定义了几种基本的数据类型，如下表所示：

<colgroup class="calibre18"><col class="calibre19"> <col class="calibre19"></colgroup> 
| `Char` | 单个字母，如‘a’、‘b’或‘+’ |
| `Short` | -32,767 到+32,768 之间的整数 |
| `Int` | -2,147,483,647 到+2,147,483,648 之间的整数 |
| `Float` | 近似值中的任意十进制值。 -1x1038 到 1x1038 |
| `Double` | 近似值中的任意十进制值。 -1x10308 至 1x10308 |
| `Bool` | 是非对错 |

上表中提到的每种变量类型都有无符号版本。 无符号变量可以包含自然数，包括 0(x>=0)。 例如，无符号`short`的值可能介于 0 和 65535 之间。

### 备注

如果您对浮点型和双精度型之间的区别更感兴趣，请随时在互联网上查找。 我将只对游戏中使用的最重要的 C++概念进行解释。 如果您对本文涵盖的内容感兴趣，请随时查阅。

事实证明，仅这些简单的数据类型就可以用来构造任意复杂的程序。 “怎么做？” 你问吧。 仅仅使用浮点数和整数来构建 3D 游戏不是很难吗？

从浮点型和整型构建游戏并不是很困难，但更复杂的数据类型会有所帮助。 如果我们使用松散的浮点作为球员的位置，那么编程将是乏味和混乱的。

## 对象类型

C++为提供了将变量组合在一起的结构，这将使您的工作变得容易得多。 以以下代码块为例：

```
#include <iostream>
using namespace std;
struct Vector        // BEGIN Vector OBJECT DEFINITION
{
  float x, y, z;     // x, y and z positions all floats
};                   // END Vector OBJECT DEFINITION.
// The computer now knows what a Vector is
// So we can create one.
int main()
{
  Vector v; // Create a Vector instance called v
  v.x=20, v.y=30, v.z=40; // assign some values
  cout << "A 3-space vector at " << v.x << ", " << v.y << ", " <<  v.z << endl;
}
```

它在内存中的外观非常直观；Vector 只是一个带有三个浮点数的内存块，如下图所示：

![Object types](../images/00027.jpeg)

### 提示

不要将前面屏幕截图中的 struct Vector 与 STL 的`std::vector`混淆。 上面的 Vector 对象用于表示一个三空间向量，而 STL 的`std::vector`类型表示一个大小的值集合。

下面是关于前面代码清单的几个复习备注：

首先，即使在我们使用 Vector 对象类型之前，我们也必须定义它。 C++没有内置的数学向量类型(它只支持标量数，他们认为这就足够了！)。 因此，C++允许您构建自己的对象构造，使您的工作变得更容易。 我们首先有了以下定义：

```
struct Vector        // BEGIN Vector OBJECT DEFINITION
{
  float x, y, z;     // x, y, and z positions all floats
};                   // END Vector OBJECT DEFINITION.
```

它告诉计算机什么是向量(它有 3 个浮点数，它们在内存中都声明为相邻)。 向量在内存中的外观如上图所示。

接下来，我们使用 Vector 对象定义创建名为`v`的 Vector 实例：

```
Vector v; // Create a Vector instance called v
```

`struct`Vector定义实际上并不创建 Vector 对象。 你不能做`Vector.x = 1`。 “您说的是哪个对象实例？” C++编译器会问。 您需要首先创建一个 Vector 实例，如 Vector v1；然后，您可以对 v1 实例进行赋值，如 v1.x=0。

然后，我们使用此实例将值写入`v`：

```
v.x=20, v.y=30, v.z=40; // assign some values
```

### 提示

我们在前面的代码中使用逗号来初始化同一行上的一串变量。 这在 C++中是可以的。 虽然您可以在各自的行上计算每个变量，但是这里显示的方法也是可以的。

这使得`v`看起来像前面屏幕截图中的。 然后，我们将它们打印出来：

```
cout << "A 3-space vector at " << v.x << ", " << v.y << ", " <<  v.z << endl;
```

在这里的两行代码中，我们只需使用一个点(`.`)就可以访问对象中的各个数据成员。 `v.x`是指对象`v`内的`x`成员。 每个 Vector 对象内部将恰好有三个浮点：一个名为`x`，一个名为`y`，一个名为`z`。

### 健身者

为 Player 对象定义一个 C++数据结构。 然后，创建 Player 类的一个实例，并用值填充每个数据成员。

#### 解决方案

让我们声明我们的 Player 对象。 我们希望将与玩家有关的所有操作组合到 Player 对象中。 我们这样做是为了使代码整洁。 您在虚幻引擎中读取的代码将在任何地方使用这样的对象；因此，请注意：

```
struct Player
{
  string name;
  int hp;
  Vector position;
}; // Don't forget this semicolon at the end!
int main()
{
  // create an object of type Player,
  Player me; // instance named 'me'
  me.name = "William";
  me.hp = 100.0f;
  me.position.x = me.position.y = me.position.z=0;
}
```

Struct player 定义告诉计算机播放器对象在内存中是如何布局的。

### 提示

我希望您注意到 struct 声明末尾的强制分号。 结构对象声明的末尾需要有分号，但函数没有。 这只是一条您必须记住的 C++规则。

在Player 对象中，我们声明了一个用于球员姓名的字符串，一个用于他的 hp 的浮点数，以及一个用于他的完整 xyz 位置的 Vector 对象。

当我说对象时，我指的是 C++结构(或者稍后，我们将介绍术语类)。

等等！ 我们将一个 Vector 对象放在一个 Player 对象中！ 是的，你可以做到的。

在定义了 Player 对象内部的内容之后，我们实际上创建了一个名为 Me 的 Player 对象实例，并为其分配了一些值。

赋值后，Me 对象如下图所示：

![Solution](../images/00028.jpeg)

## 指针

要掌握的一个特别棘手的概念是指针的概念。 指针并不难理解，但可能需要一段时间才能真正掌握。

假设我们像以前一样，在内存中声明了一个 Player 类型的变量：

```
Player me;
me.name = "William";
me.hp = 100.0f;
```

现在我们声明一个指向播放器的指针：

```
Player* ptrMe;               // Declaring a pointer
```

`*`字符通常会让事情变得特别。 在这种情况下，`*`使`ptrMe`变得特殊。 `*`使`ptrMe`成为指针类型。

我们现在要将`ptrMe`链接到我：

```
ptrMe = &me;                  // LINKAGE
```

### 提示

这一联动步骤非常重要。 如果在使用指针之前没有将指针链接到对象，则会出现内存访问冲突。

`ptrMe`现在指的是与我相同的对象。 更改`ptrMe`会更改我，如下图所示：

![Pointers](../images/00029.jpeg)

## 指针能做什么？

当我们设置指针变量和它所指向的变量之间的链接时，我们可以操作通过指针指向的变量。

指针的一个用途是从代码的几个不同位置引用同一对象。 Player 对象是一个很好的被指向的候选对象。 您可以创建任意多个指向同一对象的指针。 被指向的对象不一定知道它们正被指向，但可以通过指针对对象进行更改。

例如，假设玩家受到攻击。 他的 hp 将减少，此减少将使用指针完成，如以下代码所示：

```
ptrMe->hp -= 33;      // reduced the player's hp by 33
ptrMe->name = "John";// changed his name to John
```

下面是 Player 对象现在的外观：

![What can pointers do?](../images/00030.jpeg)

因此，我们通过改变`ptrMe->name`来改变`me.name`。 因为`ptrMe`指向我，所以通过`ptrMe`进行的更改会直接影响我。

除了时髦的箭头语法(当变量是指针时使用`->`)，这个概念并不难理解。

## 操作员地址&

请注意，前面的代码示例中使用了符号`&`。 `&`运算符获取变量的内存地址。 变量的内存地址就是它在计算机内存空间中的位置。 C++能够获取程序内存中任何对象的内存地址。 变量的地址是唯一的，也是随机的。

假设我们打印整数变量`x`的地址，如下所示：

```
int x = 22;
cout << &x << endl; // print the address of x
```

在程序第一次运行时，我的计算机打印以下内容：

```
0023F744
```

该数字(`&x`的值)只是存储变量`x`的存储单元。 这意味着，在此特定的程序启动中，变量`x`位于编号为 0023F744 的存储单元，如下图所示：

![Address of operator &](../images/00031.jpeg)

现在，创建并将指针变量分配给`x`的地址：

```
int *px;
px = &x;
```

我们在这里所做的是将`x`的内存地址存储在变量`px`内。 因此，我们使用另一个名为`px`的不同变量来比喻地指向变量`x`。 这可能与下图所示类似：

![Address of operator &](../images/00032.jpeg)

这里，变量`px`的内部有变量`x`的地址。 换言之，变量`px`是对另一变量的引用。 差分`px`表示访问`px`引用的变量。 差异是使用`*`符号完成的：

```
cout << *px << endl;
```

### 空指针

空指针是值为`0`的指针变量。 通常，大多数程序员喜欢在创建新的指针变量时初始化指向 Null(`0`)的指针。 通常，计算机程序不能访问内存地址`0`(它是保留的)，因此如果您尝试引用空指针，程序将崩溃，如以下屏幕截图所示：

![The Null pointers](../images/00033.jpeg)

### 提示

与宾基一起玩指针是一段关于指针的有趣视频。 看看[http://www.youtube.com/watch?v=i49_SNt4yfk](http://www.youtube.com/watch?v=i49_SNt4yfk)。

## ==同步，由 Elderman 更正==@ELDER_MAN

`cin`是 C++将用户输入到程序中的传统方式。 `cin`易于使用，因为它会在放入值时查看要放入的变量类型。 例如，假设我们想询问用户的年龄并将其存储在`int`变量中。 我们可以这样做：

```
cout << "What is your age?" << endl;
int age;
cin >> age;
```

## printf()

虽然我们到目前为止已经使用`cout`打印出变量，但是您需要了解用于打印到控制台的另一个常用函数。 此函数称为`printf`函数。 `printf`函数包含在`<iostream>`库中，因此您不需要`#include`任何额外的东西就可以使用它。 游戏行业的一些人更喜欢`printf`而不是`cout`(我知道我喜欢)，所以让我们来介绍一下。

让我们继续了解`printf()`是如何工作的，如以下代码所示：

```
#include <iostream>
#include <string>
using namespace std;
int main()
{
  char character = 'A';
  int integer = 1;
  printf( "integer %d, character %c\n", integer, character );
}
```

### 提示

**下载示例代码**

您可以从您的帐户[http://www.packtpub.com](http://www.packtpub.com)为您购买的所有 Packt Publishing 图书下载示例代码文件。 如果您在其他地方购买了本书，您可以访问[http://www.packtpub.com/support](http://www.packtpub.com/support)并注册，以便将文件通过电子邮件直接发送给您。

我们从格式字符串开始。 格式字符串类似于图片框，变量将插入格式字符串中`%`的位置。 然后，整个内容被转储到控制台。 在上例中，整数变量将插入第一个`%`(`%d`)的位置，而字符将插入第二个`%`(`%c`)的位置，如以下屏幕截图所示：

![printf()](../images/00034.jpeg)

您必须使用正确的格式化代码才能使输出正确格式化；请看下表：

<colgroup class="calibre18"><col class="calibre19"> <col class="calibre19"></colgroup> 
| 

数据类型

 | 

格式码

 |
| --- | --- |
| 整型 | %d |
| 柴尔 | %c |
| 细绳 | %s |

要打印 C++字符串，必须使用`string.c_str()`函数：

```
string s = "Hello";
printf( "string %s\n", s.c_str() );
```

函数`s.c_str()`访问`printf`需要的字符串的 C 指针。

如果您使用了错误的格式代码，输出将不会正确显示，或者程序可能会崩溃。

### 锻炼

询问用户的姓名和年龄，并使用`cin`接收他们。 然后，在控制台使用`printf()`(而不是`cout`)为他发出问候语。

### 解决方案

该程序的外观如下所示：

```
#include <iostream>
#include <string>
using namespace std;
int main()
{
  cout << "Name?" << endl;
  string name;
  cin >> name;
  cout << "Age?" << endl; 
  int age;
  cin >> age;
  cout << "Hello " << name << " I see you have attained " << age  << " years. Congratulations." << endl;
}
```

### 提示

字符串实际上是一种对象类型。 里面只有一堆焦炭！

# 摘要

在本章中，我们谈到了变量和内存。 我们讨论了变量的数学运算，以及它们在 C++中是多么简单。

我们还讨论了如何结合使用这些更简单的数据类型(如浮点数、整数和字符)来构建任意复杂的数据类型。 这样的构造称为对象。